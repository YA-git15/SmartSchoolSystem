<!DOCTYPE html>
<html lang='ja'>

<head>
	<meta charset='utf-8' />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href='https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css' rel='stylesheet'>
	<link href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css' rel='stylesheet'>
	<link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=M+PLUS+1:wght@100..900&display=swap" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.17/main.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
		integrity="sha384-tViUnnbYAV00FLIhhi3v/dWt3Jxw4gZQcNoSCxCIFNJVCx7/D55/wXsrNIRANwdD" crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
		integrity="sha384-tViUnnbYAV00FLIhhi3v/dWt3Jxw4gZQcNoSCxCIFNJVCx7/D55/wXsrNIRANwdD" crossorigin="anonymous">
	<link rel="stylesheet" th:href="@{/css/style.css}">
	<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.17/index.global.min.js'></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>
	<header class="container-fluid header">
		<div class="row shcool-name-and-nav">
			<div class="col-12 col-md-6 school-name">
				<a href="/home" class="d-flex align-items-center text-decoration-none text-dark">
					<img src="/images/logo_system.png" alt="ロゴ" class="img-fluid"
						style="width: 20%; margin-right: 10px;">
					<h2 class="mb-0">横浜市立新横浜小学校</h2>
				</a>
			</div>

			<div class="col-12 col-md-6 nav-link">
				<div class="row navs">
					<div class="col-3"><a th:href="@{/notices}">お知らせ</a></div>
					<div class="col-3"><a th:href="@{/events}">行事予定</a></div>
					<div class="col-3"><a th:href="@{/inqueries}">問い合わせ</a></div>
					<div class="col-3"><a th:href="@{/logout}">ログアウト</a></div>
				</div>
			</div>

		</div>


		<div class="card border-light text-dark">
			<img src="images/header.jpg" class="card-img" alt="背景画像">
			<div class="card-img-overlay d-flex">
				<div class="my-auto">
					<h1 class="page-title">行事カレンダー</h1>
					<a class="btn btn-primary" th:href="@{/events/addEvent}">
						<i class="bi bi-plus-circle"></i>行事新規追加
					</a>
				</div>
			</div>

		</div>
	</header>

	<main class="main-contents">
		<div class="conatainer-fluid">
			<div class="row">
				<div class="col-8">
					<div class="row">
						<div class="col-12 calendar-events-title">月間予定</div>
						<div class="col-12 calendar-events" id='calendar'></div>
					</div>
				</div>
				<div class="col-4">
					<div class="row">
						<div class="col-12 list-events-title">年間予定</div>
						<div class="col-12 list-events">
							<table class="table table-hover listnotice-table">
								<thead>
									<tr>
										<div class="row event-list">
											<div class="col-7 event-date">Date</div>
											<div class="col-5 event-title">行事名</div>
										</div>
									</tr>
								</thead>
								<tbody>
									<tr th:each="event : ${events}">
										<td>
											<div class="table-link"
												th:attr="data-id=${event.eventId}, data-title=${event.eventTitle}"
												onclick="showEventDetails(this)">

												<div class="row event-list">
													<div class="col-7"
														th:if="${#temporals.format(event.eventStartDatetime,'MM月dd日') == #temporals.format(event.eventEndDatetime,'MM月dd日')}">
														[[${#temporals.format(event.eventStartDatetime,'M月d日')}]]
													</div>
													<div class="col-7"
														th:if="${#temporals.format(event.eventStartDatetime,'MM月dd日') != #temporals.format(event.eventEndDatetime,'MM月dd日')}">
														[[${#temporals.format(event.eventStartDatetime,'M月d日')}]]-
														[[${#temporals.format(event.eventEndDatetime,'M月d日')}]]
													</div>



													<div class="col-5">[[${event.eventTitle}]]</div>
												</div>
											</div>
										</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>

			<!-- モーダル (ポップアップ) -->
			<div class="modal fade" id="eventDetailsModal" tabindex="-1" aria-labelledby="eventDetailsLabel"
				aria-hidden="true">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="eventDetailsLabel">行事詳細</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<p id="eventDetailsContent">詳細情報を読み込んでいます...</p>
						</div>
						<div class="modal-footer">
							<button id="openInNewWindowBtn" type="button" class="btn btn-primary">
								<i class="bi bi-box-arrow-up-right"></i>別タブで開く</button>
							<button id="openInEditWindowBtn" type="button" class="btn btn-warning">
								<i class="bi bi-pencil-square"></i>編集</button>
							<button id="openInDeleteWindowBtn" type="button" class="btn btn-danger">
								<i class="bi bi-trash"></i>削除</button>
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
								<i class="bi bi-x"></i>閉じる</button>
						</div>
					</div>
				</div>
			</div>
	</main>


	<script>
		document.addEventListener('DOMContentLoaded', function () {
			var calendarEl = document.getElementById('calendar');

			var calendar = new FullCalendar.Calendar(calendarEl, {


				displayEventTime: false,
				timeZone: 'Asia/Tokyo',  // 日本時間に設定
				locale: 'ja',
				dayCellContent: function (arg) {
					return arg.date.getDate();
				},
				width: 150,

				headerToolbar: {
					left: 'prev,next today',
					center: 'title',
					right: 'dayGridMonth,timeGridWeek,timeGridDay'
				},

				// buttonText設定
				buttonText: {
					month: '月',
					week: '週',
					day: '日',
					today: '本日'

				},

				events: '/events/json',

				// クリックイベントを追加
				eventClick: function (info) {
					var eventId = info.event.id;
					var eventTitle = info.event.title;

					var eventElement = document.createElement('div');
					eventElement.setAttribute('data-id', eventId);
					eventElement.setAttribute('data-title', eventTitle);

					showEventDetails(eventElement);

					// リンクのデフォルト動作をキャンセル
					info.jsEvent.preventDefault();
				},
			});

			calendar.setOption('aspectRatio', 1.5);
			calendar.render();
		});

		function showEventDetails(element) {
			const eventId = element.getAttribute('data-id');
			const eventTitle = element.getAttribute('data-title');

			document.getElementById('eventDetailsLabel').innerText = eventTitle + ' 詳細';

			// イベントの詳細データをフラグメントで取得
			fetch(`/events/detailEvent/${eventId}?fragment=true`)
				.then(response => response.text())
				.then(data => {
					document.getElementById('eventDetailsContent').innerHTML = data;

					// モーダルを表示
					var eventDetailsModal = new bootstrap.Modal(document.getElementById('eventDetailsModal'));
					eventDetailsModal.show();

					// 別ウィンドウで開くボタンの設定
					document.getElementById('openInNewWindowBtn').addEventListener('click', function () {
						// フルページを新しいウィンドウで開く
						window.open(`/events/detailEvent/${eventId}`, '_blank');
					});

					// 編集画面を開くボタンの設定
					document.getElementById('openInEditWindowBtn').addEventListener('click', function () {
						// 編集ページを新しいウィンドウで開く
						window.open(`/events/editEvent/${eventId}`, '_blank');
					});

					// 削除画面を開くボタンの設定
					document.getElementById('openInDeleteWindowBtn').addEventListener('click', function () {
						// 削除ページを新しいウィンドウで開く
						window.open(`/events/deleteEventConf/${eventId}`, '_blank');
					});

				})
				.catch(error => {
					console.error('エラー:', error);
					document.getElementById('eventDetailsContent').innerText = '詳細の読み込みに失敗しました。';
				});
		}

		// テーブルでもクリック時にモーダルを表示する処理を追加
		document.querySelectorAll('.event-row').forEach(function (row) {
			row.addEventListener('click', function () {
				// テーブルの行からイベントIDとタイトルを取得
				var eventId = row.getAttribute('data-id');
				var eventTitle = row.getAttribute('data-title');

				var eventElement = document.createElement('div');
				eventElement.setAttribute('data-id', eventId);
				eventElement.setAttribute('data-title', eventTitle);

				showEventDetails(eventElement);
			});
		});
	</script>

</body>

</html>